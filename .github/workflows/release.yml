# =============================================================================
# LazyFocus Release Workflow
# =============================================================================
# Purpose: Automates building, packaging, and publishing releases
#
# This workflow uses GoReleaser to:
#   - Build macOS binaries (amd64, arm64, universal)
#   - Generate release archives with checksums
#   - Create GitHub releases (draft mode for review)
#   - Update Homebrew tap with new formula version
#
# Trigger:
#   Push a version tag matching v*.*.* (e.g., v1.0.0, v1.2.3-beta)
#   Example: git tag v1.0.0 && git push origin v1.0.0
#
# Process Flow:
#   1. Tag pushed → Workflow triggered
#   2. Checkout code with full git history (for changelog generation)
#   3. Setup Go environment matching go.mod version
#   4. Run GoReleaser to build and package
#   5. Create draft GitHub release (manual review required)
#   6. Review and publish release on GitHub
#   7. Publishing triggers Homebrew tap update
#
# Requirements:
#   - GITHUB_TOKEN: Automatically provided (no setup needed)
#   - HOMEBREW_TAP_TOKEN: GitHub PAT for tap updates
#     (Settings → Secrets and variables → Actions → New repository secret)
#
# Runner Requirements:
#   - Must use macos-latest for building universal binaries
#   - Ubuntu/Linux cannot create macOS universal binaries
#
# Post-Release:
#   - Verify draft release looks correct
#   - Edit release notes if needed
#   - Publish release to make it public
#   - Users can install via: brew install geekvetica/tap/lazyfocus
#
# =============================================================================

name: Release

on:
  # Trigger on version tags only
  # Examples: v1.0.0, v2.1.3, v1.0.0-beta.1
  push:
    tags:
      - 'v*.*.*'

  # Allow manual workflow dispatch for testing
  workflow_dispatch:

# Ensure only one release runs at a time
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Job: release
  # ===========================================================================
  # Builds binaries, creates archives, and publishes GitHub release
  # Uses GoReleaser for all build and packaging automation
  #
  # Platform: macOS required for universal binary creation
  # GoReleaser's universal binary feature only works on macOS runners
  # ===========================================================================
  release:
    name: Release
    runs-on: macos-latest

    # Only run on the main repository (skip forks)
    if: github.repository == 'Geekvetica/lazyfocus'

    # Required for GitHub release creation
    permissions:
      contents: write
      packages: write

    steps:
      # Checkout with full history for changelog generation
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for git log and changelog

      # Setup Go using version from go.mod
      # Ensures consistency with development environment
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      # Run GoReleaser to build, package, and release
      # Configuration in .goreleaser.yaml
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@90a3faa9d0182683851fbfa97ca1a2cb983bfca3  # v6.2.1
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean
        env:
          # GitHub token for creating releases
          # Automatically provided by GitHub Actions
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # Homebrew tap token for formula updates
          # Must be added as repository secret
          # Generate at: https://github.com/settings/tokens
          # Required scope: repo:public_repo
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      # Upload artifacts to workflow run for debugging
      # Useful if release creation fails but binaries built successfully
      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: release-artifacts
          path: dist/
          retention-days: 5
